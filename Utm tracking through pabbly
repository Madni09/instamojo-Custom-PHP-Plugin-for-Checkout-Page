<script>
/* -------------------------------
   LIGHTWEIGHT PABBLY WEBHOOK LOG
--------------------------------- */

const PABBLY_WEBHOOK_URL = "https://connect.pabbly.com/workflow/sendwebhookdata/pc";

// Extract UTMs safely
function getUTMParams() {
  const params = new URLSearchParams(window.location.search);
  return {
    utm_source: params.get("utm_source") || "",
    utm_medium: params.get("utm_medium") || "",
    utm_campaign: params.get("utm_campaign") || "",
    utm_term: params.get("utm_term") || "",
    utm_content: params.get("utm_content") || ""
  };
}

// Read fields using your existing getFormData() function
function sendDataToPabbly() {
  if (typeof getFormData !== "function") {
    console.error("getFormData() not found!");
    return;
  }

  const f = getFormData();
  const pricing = typeof buildPricingPayload === "function"
    ? buildPricingPayload()
    : { base: 0, extra198: 0, extra199: 0 };

  const totalAmount = pricing.base + pricing.extra198 + pricing.extra199;
  const utm = getUTMParams();

  const payload = {
    name: f.name || "",
    email: f.email || "",
    phone: f.phone || "",
    amount: totalAmount || "",
    utm_source: utm.utm_source,
    utm_medium: utm.utm_medium,
    utm_campaign: utm.utm_campaign,
    utm_term: utm.utm_term,
    utm_content: utm.utm_content
  };

  const body = JSON.stringify(payload);

  // Try sendBeacon first (best for reliability)
  if (navigator.sendBeacon) {
    const blob = new Blob([body], { type: "text/plain" });
    navigator.sendBeacon(PABBLY_WEBHOOK_URL, blob);
    return;
  }

  // Fallback â€” no-cors POST
  fetch(PABBLY_WEBHOOK_URL, {
    method: "POST",
    body: body,
    mode: "no-cors",
    headers: { "Content-Type": "text/plain" },
    keepalive: true
  }).catch(err => console.warn("Webhook error:", err));
}

// Attach click listener WITHOUT affecting original script
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("imj-button");
  if (!btn) return;

  btn.addEventListener("click", () => {
    sendDataToPabbly();
  });
});
</script>
